<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Corralón App</title>
  <link rel="icon" href="https://i.postimg.cc/fbm2zq4k/chad.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    body { background: #f0f2f5; font-family: sans-serif; }
    #loader { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(255,255,255,0.9); z-index: 9999; 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    #login-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #212529; z-index: 9998;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .hidden { display: none !important; }
    .kpi-card { border-left: 5px solid gray; }
    .kpi-ing { border-color: #198754; }
    .kpi-egr { border-color: #dc3545; }
    .kpi-bal { border-color: #0d6efd; }
  </style>
</head>
<body>

  <div id="login-screen" class="hidden">
    <div class="card p-4 shadow-lg" style="width: 300px; text-align: center;">
      <h5 class="mb-3"><i class="bi bi-shield-lock-fill text-primary"></i> Acceso Restringido</h5>
      <input type="password" id="pass-input" class="form-control mb-3" placeholder="Contraseña..." onkeydown="if(event.key==='Enter') doLogin()">
      <button class="btn btn-primary w-100" onclick="doLogin()">Ingresar</button>
    </div>
  </div>

  <div id="loader">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-3 fw-bold">Cargando sistema...</div>
    <div id="error-msg" class="text-danger mt-2"></div>
  </div>

  <nav class="navbar navbar-dark bg-dark mb-4 px-3">
    <a class="navbar-brand" href="#"><i class="bi bi-box-seam"></i> GESTIÓN CORRALÓN</a>
    <div>
      <button class="btn btn-outline-light btn-sm me-2" onclick="showSection('movs')">Movimientos</button>
      <button class="btn btn-outline-light btn-sm" onclick="showSection('cli')">Clientes</button>
    </div>
  </nav>

  <div class="container" id="sec-movs">
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card shadow-sm kpi-card kpi-ing">
          <div class="card-body">
            <h6 class="text-muted">Ingresos</h6>
            <h3 id="kpi-ing">$0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm kpi-card kpi-egr">
          <div class="card-body">
            <h6 class="text-muted">Egresos</h6>
            <h3 id="kpi-egr">$0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm kpi-card kpi-bal">
          <div class="card-body">
            <h6 class="text-muted">Balance</h6>
            <h3 id="kpi-bal">$0</h3>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-3">
            <label class="small">Tipo</label>
            <select id="fil-tipo" class="form-select form-select-sm" onchange="loadMovs()">
              <option value="">Todos</option><option value="Ingreso">Ingreso</option><option value="Egreso">Egreso</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="small">Cliente</label>
            <select id="fil-cli" class="form-select form-select-sm" onchange="loadMovs()"></select>
          </div>
          <div class="col-md-6 text-end d-flex align-items-end justify-content-end">
            <button class="btn btn-primary btn-sm" onclick="openMovModal()"><i class="bi bi-plus-lg"></i> Nuevo Movimiento</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Fecha</th><th>Tipo</th><th>Cliente</th><th>Descripción</th><th>Monto</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tb-movs"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="container hidden" id="sec-cli">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>Clientes</h4>
      <button class="btn btn-success btn-sm" onclick="openCliModal()"><i class="bi bi-person-plus"></i> Nuevo</button>
    </div>
    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light"><tr><th>Nombre</th><th>Teléfono</th><th>Acciones</th></tr></thead>
          <tbody id="tb-cli"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal fade" id="mdlMov" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Movimiento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="frmMov">
            <input type="hidden" name="_row" id="mRow">
            <input type="hidden" name="IDObra" id="mId">
            
            <div class="row g-2 mb-2">
              <div class="col-6"><label>Tipo</label><select name="Tipo" id="mTipo" class="form-select" onchange="toggleForm()" required><option value="Ingreso">Ingreso</option><option value="Egreso">Egreso</option></select></div>
              <div class="col-6"><label>Fecha</label><input type="date" name="Fecha" id="mFec" class="form-control" required></div>
            </div>
            
            <div class="mb-2"><label>Cliente</label><select name="Cliente" id="mCli" class="form-select" required></select></div>
            <div class="mb-2"><label>Descripción</label><input type="text" name="Descripcion" id="mDesc" class="form-control" required></div>
            
            <div class="row g-2 mb-2">
              <div class="col-6"><label>Monto</label><input type="number" name="Monto" id="mMont" class="form-control" step="0.01" required></div>
              <div class="col-6"><label>Estado</label><select name="Estado" id="mEst" class="form-select"></select></div>
            </div>

            <div id="grpIng">
              <div class="mb-2"><label>Forma</label><select name="Forma" id="mForm" class="form-select"></select></div>
            </div>
            <div id="grpEgr" class="hidden">
              <div class="row g-2">
                <div class="col-6"><label>Proveedor</label><input type="text" name="Proveedor" id="mProv" class="form-control"></div>
                <div class="col-6"><label>Empleado</label><input type="text" name="Empleado" id="mEmp" class="form-control"></div>
              </div>
            </div>
            
            <div class="row g-2 mt-2">
                <div class="col-6"><label class="small">Presupuesto</label><input type="number" name="Presupuesto" id="mPres" class="form-control form-control-sm"></div>
                <div class="col-6"><label class="small">Foto URL</label><input type="text" name="Foto" id="mFot" class="form-control form-control-sm"></div>
             </div>
             <div class="mb-2 mt-2"><label class="small">Detalle</label><textarea name="Detalle" id="mDet" class="form-control form-control-sm" rows="2"></textarea></div>

          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary w-100" onclick="saveMov()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="mdlCli" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Cliente</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="frmCli">
            <input type="hidden" name="_row" id="cRow">
            <input type="hidden" name="IDClientes" id="cId">
            <div class="mb-2"><label>Nombre</label><input type="text" name="Nombre" id="cNom" class="form-control" required></div>
            <div class="mb-2"><label>Teléfono</label><input type="text" name="Telefono" id="cTel" class="form-control"></div>
            <div class="mb-2"><label>Dirección</label><input type="text" name="Direccion" id="cDir" class="form-control"></div>
          </form>
        </div>
        <div class="modal-footer"><button class="btn btn-primary w-100" onclick="saveCli()">Guardar</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const el = id => document.getElementById(id);
    const val = id => el(id).value;
    const hideLoader = () => el('loader').classList.add('hidden');
    const showLoader = () => el('loader').classList.remove('hidden');

let DB = { clientes: [], estados: [], formas: [] };
    
    const API_URL = "https://script.google.com/macros/s/AKfycbwuHvMG5qEvH7EbOLlcYn22a9Vmla59ISGGfqJI0zrwcm1jAlSZjzkAsJFEGovRyNjFDg/exec";
    
    // Función centralizada para llamadas a la API (Evita bloqueos CORS usando text/plain)
    async function fetchAPI(action, data = {}) {
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action, data })
        });
        return await res.json();
      } catch (e) {
        return { success: false, error: "Error de red: " + e.toString() };
      }
    }

// INIT & LOGIN
    window.onload = () => {
      if (sessionStorage.getItem("auth") === "ok") {
        initApp(); // Ya validado en esta sesión
      } else {
        hideLoader();
        el('login-screen').classList.remove('hidden');
      }
    };

    async function doLogin() {
      const p = val('pass-input');
      if (!p) return;
      showLoader();
      const res = await fetchAPI("checkAuth", { pass: p });
      if (res.success) {
        sessionStorage.setItem("auth", "ok");
        el('login-screen').classList.add('hidden');
        initApp();
      } else {
        hideLoader();
        alert(res.error);
        el('pass-input').value = "";
      }
    }

    async function initApp() {
      showLoader();
      const [resInit, resMovs] = await Promise.all([
        fetchAPI("getInitData"),
        fetchAPI("listMovimientos", { tipo: "", cliente: "" })
      ]);

      if(!resInit.success) return showError(resInit.error);
      DB.clientes = resInit.data.clientes;
      DB.estados = resInit.data.estados;
      DB.formas = resInit.data.formas;

      fillSelect('fil-cli', DB.clientes, 'id', 'nombre', 'Todos');
      fillSelect('mCli', DB.clientes, 'id', 'nombre');
      fillList('mEst', DB.estados);
      fillList('mForm', DB.formas);

      if(!resMovs.success) { hideLoader(); return alert(resMovs.error); }
      renderMovs(resMovs.rows);
      renderKPIs(resMovs.totals);
      hideLoader();
    }

    // MOVIMIENTOS
async function loadMovs() {
      showLoader();
      const filters = {
        tipo: val('fil-tipo'),
        cliente: val('fil-cli')
      };
      
      const res = await fetchAPI("listMovimientos", filters);
      hideLoader();
      if(!res.success) return alert(res.error);
      renderMovs(res.rows);
      renderKPIs(res.totals);
    }

    function renderMovs(rows) {
      const tb = el('tb-movs');
      tb.innerHTML = '';
      if(rows.length === 0) tb.innerHTML = '<tr><td colspan="6" class="text-center p-3">Sin datos</td></tr>';
      
      rows.forEach(r => {
        const color = r.Tipo === 'Ingreso' ? 'text-success' : 'text-danger';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.Fecha}</td>
          <td><span class="badge ${r.Tipo==='Ingreso'?'bg-success':'bg-danger'}">${r.Tipo}</span></td>
          <td>${r.ClienteNombre}</td>
          <td>${r.Descripcion}</td>
          <td class="fw-bold ${color}">$${formatMoney(r.Monto)}</td>
          <td>
            <button class="btn btn-sm btn-light border" onclick='editMov(${JSON.stringify(r)})'><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-light border text-danger" onclick="delMov(${r._row})"><i class="bi bi-trash"></i></button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    function renderKPIs(t) {
      el('kpi-ing').innerText = '$' + formatMoney(t.ingresos);
      el('kpi-egr').innerText = '$' + formatMoney(t.egresos);
      el('kpi-bal').innerText = '$' + formatMoney(t.balance);
    }

    // FORM MOV
    function openMovModal() {
      el('frmMov').reset();
      el('mRow').value = '';
      el('mId').value = '';
      el('mFec').valueAsDate = new Date();
      toggleForm();
      new bootstrap.Modal(el('mdlMov')).show();
    }

    function editMov(r) {
      openMovModal();
      el('mRow').value = r._row;
      el('mId').value = r.IDObra;
      el('mTipo').value = r.Tipo;
      el('mFec').value = r.Fecha;
      el('mCli').value = r.Cliente;
      el('mDesc').value = r.Descripcion;
      el('mMont').value = r.Monto;
      el('mEst').value = r.Estado;
      el('mForm').value = r.Forma;
      el('mProv').value = r.Proveedor;
      el('mEmp').value = r.Empleado;
      el('mDet').value = r.Detalle;
      el('mPres').value = r.Presupuesto;
      el('mFot').value = r.Foto;
      toggleForm();
    }

async function saveMov() {
      const form = el('frmMov');
      if(!form.checkValidity()) return form.reportValidity();
      
      const data = getFormData(form);
      showLoader();
      
      const res = await fetchAPI("saveMovimiento", data);
      if(!res.success) { hideLoader(); alert(res.error); return; }
      bootstrap.Modal.getInstance(el('mdlMov')).hide();
      loadMovs();
    }

    async function delMov(row) {
      if(!confirm('¿Eliminar?')) return;
      showLoader();
      const res = await fetchAPI("deleteMovimiento", row);
      if(!res.success) { hideLoader(); alert(res.error); return; }
      loadMovs();
    }

    // CLIENTES
async function loadCli() {
      showLoader();
      const res = await fetchAPI("listClientes");
      hideLoader();
      if(!res.success) { alert(res.error); return; }
      
      const tb = el('tb-cli');
      tb.innerHTML = '';
      res.rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.Nombre}</td><td>${r.Telefono}</td>
        <td>
           <button class="btn btn-sm btn-light border" onclick='editCli(${JSON.stringify(r)})'><i class="bi bi-pencil"></i></button>
           <button class="btn btn-sm btn-light border text-danger" onclick="delCli(${r._row})"><i class="bi bi-trash"></i></button>
        </td>`;
        tb.appendChild(tr);
      });
    }

    function openCliModal() {
      el('frmCli').reset();
      el('cRow').value = '';
      el('cId').value = '';
      new bootstrap.Modal(el('mdlCli')).show();
    }
    
    function editCli(r) {
      openCliModal();
      el('cRow').value = r._row;
      el('cId').value = r.IDClientes;
      el('cNom').value = r.Nombre;
      el('cTel').value = r.Telefono;
      el('cDir').value = r.Direccion;
    }

async function saveCli() {
      const form = el('frmCli');
      if(!form.checkValidity()) return form.reportValidity();
      showLoader();
      
      const resSave = await fetchAPI("saveCliente", getFormData(form));
      if(!resSave.success) { hideLoader(); alert(resSave.error); return; }
      
      bootstrap.Modal.getInstance(el('mdlCli')).hide();
      
      // Recargamos la grilla y los catálogos en paralelo
      const [resCli, resInit] = await Promise.all([
        fetchAPI("listClientes"),
        fetchAPI("getInitData")
      ]);
      
      if(resCli.success) {
        const tb = el('tb-cli');
        tb.innerHTML = '';
        resCli.rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.Nombre}</td><td>${r.Telefono}</td>
          <td>
             <button class="btn btn-sm btn-light border" onclick='editCli(${JSON.stringify(r)})'><i class="bi bi-pencil"></i></button>
             <button class="btn btn-sm btn-light border text-danger" onclick="delCli(${r._row})"><i class="bi bi-trash"></i></button>
          </td>`;
          tb.appendChild(tr);
        });
      }
      
      if(resInit.success) { 
          DB.clientes = resInit.data.clientes; 
          fillSelect('fil-cli', DB.clientes, 'id', 'nombre', 'Todos'); 
          fillSelect('mCli', DB.clientes, 'id', 'nombre'); 
      }
      hideLoader();
    }

    async function delCli(row) {
      if(!confirm('¿Eliminar cliente?')) return;
      showLoader();
      const res = await fetchAPI("deleteCliente", row);
      if(!res.success) { hideLoader(); alert(res.error); return; }
      loadCli();
    }

    // UTILS
    function toggleForm() {
      const isIng = val('mTipo') === 'Ingreso';
      el('grpIng').classList.toggle('hidden', !isIng);
      el('grpEgr').classList.toggle('hidden', isIng);
      el('mForm').required = isIng;
    }

    function showSection(sec) {
      el('sec-movs').classList.add('hidden');
      el('sec-cli').classList.add('hidden');
      el('sec-' + sec).classList.remove('hidden');
      if(sec === 'cli') loadCli();
    }

    function showError(e) {
      el('error-msg').innerText = "ERROR CRÍTICO: " + e;
    }

    function fillSelect(id, data, valKey, txtKey, placeholder) {
      const s = el(id); s.innerHTML = '';
      if(placeholder) s.add(new Option(placeholder, ""));
      data.forEach(x => s.add(new Option(x[txtKey], x[valKey])));
    }
    
    function fillList(id, list) {
      const s = el(id); s.innerHTML = '';
      list.forEach(x => s.add(new Option(x, x)));
    }

    function getFormData(form) {
      const fd = new FormData(form);
      const obj = {};
      fd.forEach((value, key) => obj[key] = value);
      return obj;
    }
    
    const formatMoney = n => new Intl.NumberFormat('es-AR', {minimumFractionDigits: 2}).format(n);
  </script>
</body>
</html>
